{
  "standings": [
    {
      "position": 1,
      "pilot_name": "Mauro",
      "psn_id": "TLM_Sicily",
      "team": "TLM",
      "points": 75,
      "wins": 5,
      "category": "Ufficiali"
    },
    {
      "position": 2,
      "pilot_name": "Michael", 
      "psn_id": "Mikedb_91_",
      "team": "TLM",
      "points": 68,
      "wins": 3,
      "category": "Ufficiali"
    }
  ]
}

<style>
    /* Reclami styles */
    .reclami-list {
        display: grid;
        gap: 15px;
    }
    
    .reclamo-card {
        background: #1a1a1a;
        border-left: 4px solid #e10600;
        padding: 20px;
        border-radius: 8px;
    }
    
    .reclamo-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-pending { background: #ffc107; color: #000; }
    .status-accepted { background: #4caf50; color: #fff; }
    .status-rejected { background: #f44336; color: #fff; }
    
    .btn-submit {
        width: 100%;
        padding: 16px;
        background: #e10600;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-submit:hover {
        background: #c10500;
        transform: translateY(-2px);
    }

    /* Credits API styles */
    .credits-dashboard {
        padding: 20px;
    }

    .credits-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .credit-card {
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        border: 2px solid #e10600;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(225, 6, 0, 0.2);
        transition: all 0.3s;
    }

    .credit-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(225, 6, 0, 0.4);
    }

    .credit-label {
        color: #888;
        font-size: 0.9rem;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .credit-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #e10600;
        font-family: 'Courier New', monospace;
    }

    .credits-actions {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        justify-content: center;
    }

    .btn-refresh, .btn-recharge {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1rem;
    }

    .btn-refresh {
        background: #333;
        color: white;
    }

    .btn-refresh:hover {
        background: #444;
        transform: scale(1.05);
    }

    .btn-recharge {
        background: #4caf50;
        color: white;
    }

    .btn-recharge:hover {
        background: #45a049;
        transform: scale(1.05);
    }

    .credits-history {
        background: #1a1a1a;
        border-radius: 12px;
        padding: 20px;
    }

    .credits-history h3 {
        color: #e10600;
        margin-bottom: 20px;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
    }

    .history-table {
        width: 100%;
        border-collapse: collapse;
    }

    .history-table th {
        background: #2a2a2a;
        padding: 12px;
        text-align: left;
        color: #e10600;
        font-weight: bold;
    }

    .history-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #333;
    }

    .history-table tr:hover {
        background: #2a2a2a;
    }

    .status-200 { color: #4caf50; }
    .status-400, .status-404 { color: #ffc107; }
    .status-429, .status-500 { color: #f44336; }

    /* Home section styles */
    #homeSection {
        padding: 20px;
        background: #121212;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .action-btn {
        padding: 15px;
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
    }

    .action-btn:hover {
        background: #e10600;
        border-color: #e10600;
    }

    /* Standings section styles */
    #standingsSection {
        padding: 20px;
        background: #121212;
        border-radius: 8px;
    }

    .filters {
        margin-bottom: 20px;
    }

    .filters select {
        padding: 8px 16px;
        margin-right: 10px;
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 6px;
        color: white;
    }

    /* Navigation styles */
    .nav {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .nav-btn {
        flex: 1;
        padding: 10px;
        background: #1a1a1a;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
    }

    .nav-btn.active {
        background: #e10600;
    }

    /* Notification styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 1000;
        transition: opacity 0.3s;
    }

    .notification.info { background: #007bff; }
    .notification.success { background: #28a745; }
    .notification.warning { background: #ffc107; }
    .notification.error { background: #dc3545; }

    .upload-form {
  margin: 20px 0;
  padding: 20px;
  background: #1a1a1a;
  border-radius: 8px;
}

#uploadStatus {
  margin-top: 10px;
  color: #999;
}
</style>

<script>
// DATABASE CONNECTION
const DB_CONFIG = {
    apiUrl: '/.netlify/functions/api',  // single Netlify Function handler
    endpoints: {
        standings: '/standings',
        races: '/races',
        pilots: '/pilots',
        complaints: '/complaints',
        auth: '/auth',
        campionati: '/campionati',
        bacheca_vittorie: '/bacheca/vittorie',
        bacheca_avvisi: '/bacheca/avvisi',
        allenamenti: '/allenamenti'
    }
};

// APP STATE
let currentUser = null;
let standings = [];
let races = [];
let pilots = [];
let complaints = [];

// INIT APP
async function initDashboard() {
    try {
        // Carica tutti i dati necessari
        await Promise.all([
            loadStandings(),
            loadRaces(),
            loadPilots(),
            loadComplaints()
        ]);

        // Render initial views
        renderStandings();
        renderRaces();
        renderPilots();
        renderMyComplaints();
        
        showNotification('‚úÖ Dati caricati con successo');
    } catch (error) {
        showNotification('‚ùå Errore caricamento dati: ' + error.message);
    }
}

// DATA LOADING
async function loadStandings() {
    const response = await fetch(`${DB_CONFIG.apiUrl}${DB_CONFIG.endpoints.standings}`);
    if (!response.ok) throw new Error('Errore caricamento classifiche');
    standings = await response.json();
}

async function loadRaces() {
    const response = await fetch(`${DB_CONFIG.apiUrl}${DB_CONFIG.endpoints.races}`);
    if (!response.ok) throw new Error('Errore caricamento gare');
    races = await response.json();
}

// RENDER FUNCTIONS
function renderStandings(filters = {}) {
    const table = document.getElementById('standingsTable');
    if (!table) return;

    let filtered = [...standings];
    
    // Applica filtri
    if (filters.championship) {
        filtered = filtered.filter(s => s.championship === filters.championship);
    }
    if (filters.category) {
        filtered = filtered.filter(s => s.category === filters.category);
    }

    // Ordina per punti
    filtered.sort((a, b) => b.points - a.points);

    table.innerHTML = filtered.map((pilot, index) => `
        <tr>
            <td><span class="position-badge">${index + 1}</span></td>
            <td><strong>${pilot.psn_id}</strong></td>
            <td><span class="category-badge badge-${pilot.category.toLowerCase()}">${pilot.category}</span></td>
            <td><strong>${pilot.points}</strong> punti</td>
            <td>üèÜ ${pilot.wins || 0}</td>
            <td>${pilot.team}</td>
        </tr>
    `).join('');
}

// RACE MANAGEMENT
async function submitRaceResult(raceData) {
    try {
        const response = await fetch(`${DB_CONFIG.apiUrl}${DB_CONFIG.endpoints.races}/results`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.token}`
            },
            body: JSON.stringify(raceData)
        });

        if (!response.ok) throw new Error('Errore salvataggio risultato');
        
        await loadStandings(); // Ricarica classifiche
        renderStandings();
        showNotification('‚úÖ Risultato salvato con successo');
    } catch (error) {
        showNotification('‚ùå Errore: ' + error.message);
    }
}

// COMPLAINT SYSTEM
async function submitComplaint(complaintData) {
    try {
        const response = await fetch(`${DB_CONFIG.apiUrl}${DB_CONFIG.endpoints.complaints}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.token}`
            },
            body: JSON.stringify({
                ...complaintData,
                submittedBy: currentUser.psn_id,
                timestamp: new Date().toISOString()
            })
        });

        if (!response.ok) throw new Error('Errore invio reclamo');
        
        await loadComplaints();
        renderMyComplaints();
        showNotification('‚úÖ Reclamo inviato con successo');
    } catch (error) {
        showNotification('‚ùå Errore: ' + error.message);
    }
}

// EVENT LISTENERS
document.getElementById('raceResultForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    await submitRaceResult(Object.fromEntries(formData));
});

document.getElementById('complaintForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    await submitComplaint(Object.fromEntries(formData));
});

// File Upload Handler
document.getElementById('uploadForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fileInput = document.getElementById('fileInput');
  const status = document.getElementById('uploadStatus');
  const file = fileInput.files[0];
  
  if (!file) {
    showNotification('Seleziona un file', 'error');
    return;
  }

  status.textContent = 'Uploading...';
  
  try {
    // Convert to base64
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async () => {
      const base64File = reader.result.split(',')[1];
      
      const response = await fetch('/.netlify/functions/upload_to_supabase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          file: base64File,
          path: file.name
        })
      });

      if (!response.ok) throw new Error('Upload failed');
      
      const data = await response.json();
      showNotification('‚úÖ Upload completato', 'success');
      status.textContent = `File caricato: ${data.url}`;
    };
  } catch (error) {
    showNotification('‚ùå Errore upload: ' + error.message, 'error');
    status.textContent = 'Upload fallito';
  }
});

// UTILS
function showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.textContent = message;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
}

// Navigation and Section Management
const MENU_SECTIONS = {
    home: {
        id: 'homeSection',
        render: renderHome,
        adminOnly: false
    },
    standings: {
        id: 'standingsSection', 
        render: renderStandings,
        adminOnly: false
    },
    calendar: {
        id: 'calendarSection',
        render: renderCalendar,
        adminOnly: false
    },
    pilots: {
        id: 'pilotsSection',
        render: renderPilots,
        adminOnly: false
    },
    profile: {
        id: 'profileSection',
        render: renderProfile,
        adminOnly: false
    },
    complaints: {
        id: 'complaintsSection',
        render: renderComplaints,
        adminOnly: false
    },
    admin: {
        id: 'adminSection',
        render: renderAdmin,
        adminOnly: true
    }
};

function initNavigation() {
    // Nascondi sezione admin se non autorizzato
    if (!currentUser?.isAdmin) {
        document.getElementById('adminButton').style.display = 'none';
    }

    // Aggiungi event listener per ogni bottone
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const section = btn.dataset.section;
            if (MENU_SECTIONS[section].adminOnly && !currentUser?.isAdmin) {
                showNotification('‚ùå Accesso non autorizzato');
                return;
            }
            
            // Attiva sezione
            activateSection(section);
            
            // Render contenuto
            MENU_SECTIONS[section].render();
        });
    });
}

function activateSection(sectionId) {
    // Rimuovi active da tutti i bottoni e sezioni
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    
    // Attiva bottone e sezione corrente
    document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
    document.getElementById(MENU_SECTIONS[sectionId].id).classList.add('active');
}

// Inizializza al caricamento
document.addEventListener('DOMContentLoaded', () => {
    initNavigation();
    // Attiva home di default
    activateSection('home');
});

{ 
/* --- NEW/REPLACED JS: implementazione completa delle funzioni richieste --- */

/* AUTH */
async function loginUser(email, password) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/auth/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email, password})
        });
        if (!res.ok) return handleApiError(res);
        const data = await res.json();
        updateLocalStorage('auth_token', data.token);
        currentUser = { email: data.user.email, psn_id: data.user.psn_id, isAdmin: data.user.isAdmin, token: data.token };
        checkAdminStatus();
        initAfterLogin();
        showNotification('Login eseguito', 'success');
        return true;
    } catch (err) { showNotification(err.message, 'error'); return false; }
}

function logoutUser() {
    updateLocalStorage('auth_token', null);
    currentUser = null;
    // reset UI
    renderHome();
    showNotification('Logout effettuato', 'info');
}

async function checkAdminStatus() {
    if (!currentUser?.token) return false;
    const token = getToken();
    // token payload or endpoint
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) return false;
        const u = await res.json();
        currentUser.isAdmin = u.isAdmin;
        // show/hide admin
        document.getElementById('adminButton').style.display = currentUser.isAdmin ? '' : 'none';
        return currentUser.isAdmin;
    } catch { return false; }
}

async function verifyToken(token) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/auth/verify`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({token})
        });
        return res.ok;
    } catch { return false; }
}

function getToken() {
    return getFromLocalStorage('auth_token') || currentUser?.token || null;
}

/* HOME */
function renderHome() {
    renderQuickStats();
    renderNextRace();
    renderLatestResults();
}

async function renderQuickStats() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/stats`);
        if (!res.ok) return;
        const stats = await res.json();
        // minimal render: replace or create container
        const el = document.getElementById('quickStats') || document.createElement('div');
        el.id = 'quickStats';
        el.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Piloti</div><div class="stat-value">${stats.totalPilots}</div></div>
                <div class="stat-card"><div class="stat-label">Campionati</div><div class="stat-value">${stats.totalChampionships}</div></div>
                <div class="stat-card"><div class="stat-label">Gare (oggi)</div><div class="stat-value">${stats.todaysRaces}</div></div>
            </div>
        `;
        document.getElementById('homeSection').appendChild(el);
    } catch (err) { handleApiError(err); }
}

async function renderNextRace() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/gare/prossime`);
        if (!res.ok) return;
        const data = await res.json();
        const next = data[0];
        const container = document.getElementById('nextRace') || document.createElement('div');
        container.id = 'nextRace';
        container.innerHTML = next ? `<h3>Prossima Gara: ${next.name} - ${formatDate(next.data_gara)}</h3>` : '<p>No upcoming races</p>';
        document.getElementById('homeSection').appendChild(container);
    } catch (err) { handleApiError(err); }
}

async function renderLatestResults() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/classifica?limit=5`);
        if (!res.ok) return;
        const top = await res.json();
        const el = document.getElementById('latestResults') || document.createElement('div');
        el.id = 'latestResults';
        el.innerHTML = `<h4>Top 5</h4><ul>${top.map(p=>`<li>${p.psn_id} ‚Äî ${p.points} pts</li>`).join('')}</ul>`;
        document.getElementById('homeSection').appendChild(el);
    } catch (err) { handleApiError(err); }
}

/* STANDINGS */
async function loadStandingsData() {
    try { await loadStandings(); } catch (e) { handleApiError(e); }
}

async function updateStandings(championshipId, payload) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/classifica`, {
            method: 'PUT', headers: {'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
            body: JSON.stringify({ championshipId, payload })
        });
        if (!res.ok) return handleApiError(res);
        await loadStandings();
        renderStandings();
    } catch (err) { handleApiError(err); }
}

function filterStandings() {
    const championship = document.getElementById('championshipSelect')?.value || 'all';
    const category = document.getElementById('categorySelect')?.value || 'all';
    renderStandings({ championship: championship === 'all' ? null : championship, category: category === 'all' ? null : category });
}

/* RACES / CALENDAR */
async function loadRaces() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/gare`);
        if (!res.ok) return handleApiError(res);
        races = await res.json();
    } catch (err) { handleApiError(err); }
}

function renderCalendar() {
    const container = document.getElementById('calendarSection');
    if (!container) return;
    const list = races.slice(0, 20).map(r => `<div class="event-card">
        <div><strong>${r.name}</strong><div>${r.circuito}</div><div>${formatDate(r.data_gara)}</div></div>
        <div><button onclick="showRaceDetails(${r.id})">Dettagli</button></div>
    </div>`).join('');
    container.innerHTML = `<h2>Calendario</h2>${list}`;
}

async function showRaceDetails(id) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/gare/${id}`);
        if (!res.ok) return handleApiError(res);
        const race = await res.json();
        // create modal
        const modal = document.getElementById('modal') || createModal();
        modal.querySelector('.modal-body').innerHTML = `<h3>${race.name}</h3><p>${race.circuito}</p><p>${formatDate(race.data_gara)}</p>`;
        modal.style.display = 'block';
    } catch (err) { handleApiError(err); }
}

async function registerForRace(raceId) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/gare/${raceId}/iscrizione`, {
            method: 'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
            body: JSON.stringify({ psn_id: currentUser.psn_id })
        });
        if (!res.ok) return handleApiError(res);
        showNotification('‚úÖ Iscrizione effettuata','success');
    } catch (err) { handleApiError(err); }
}

async function withdrawFromRace(raceId) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/gare/${raceId}/iscrizione`, {
            method: 'DELETE', headers: {'Authorization':`Bearer ${getToken()}`}
        });
        if (!res.ok) return handleApiError(res);
        showNotification('‚ùå Ritirato dalla gara','info');
    } catch (err) { handleApiError(err); }
}

function closeModal() {
    const m = document.getElementById('modal');
    if (m) m.style.display = 'none';
}

/* PILOTS */
async function loadPilotsData() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/piloti`);
        if (!res.ok) return handleApiError(res);
        pilots = await res.json();
    } catch (err) { handleApiError(err); }
}

function renderPilots(filters = {}) {
    const container = document.getElementById('pilotsSection');
    if (!container) return;
    const rows = pilots.filter(p => {
        if (filters.category && p.category !== filters.category) return false;
        if (filters.number && p.numero !== Number(filters.number)) return false;
        return true;
    }).map(p => `<tr onclick="showPilotDetails('${p.id}')"><td>${p.numero}</td><td>${p.nome}</td><td>${p.psn_id}</td><td>${p.gt_id}</td><td>${p.categoria}</td></tr>`).join('');
    container.innerHTML = `<h2>Piloti</h2><table><tbody>${rows}</tbody></table>`;
}

function filterPilots() {
    const category = document.getElementById('pilotCategory')?.value;
    const number = document.getElementById('pilotNumber')?.value;
    renderPilots({ category, number });
}

async function showPilotDetails(id) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/pilota/${id}/stats`);
        if (!res.ok) return handleApiError(res);
        const stats = await res.json();
        const modal = createModal();
        modal.querySelector('.modal-body').innerHTML = `<h3>${stats.nome}</h3><p>Vittorie: ${stats.vittorie}</p><p>Punti: ${stats.punti}</p>`;
        modal.style.display = 'block';
    } catch (err) { handleApiError(err); }
}

/* PROFILE */
async function renderProfile() {
    if (!currentUser) return showNotification('Login richiesto', 'warning');
    await loadUserStats();
    await loadUserRaces();
    await loadUserChampionships();
    const el = document.getElementById('profileSection');
    el.innerHTML = `<h2>Profilo: ${currentUser.psn_id || currentUser.email}</h2>`;
}

async function loadUserStats() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/pilota/${currentUser.psn_id}/stats`);
        if (!res.ok) return;
        return await res.json();
    } catch (err) { handleApiError(err); }
}

async function loadUserRaces() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/pilota/${currentUser.psn_id}/gare`);
        if (!res.ok) return;
        return await res.json();
    } catch (err) { handleApiError(err); }
}

async function loadUserChampionships() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/pilota/${currentUser.psn_id}/campionati`);
        if (!res.ok) return;
        return await res.json();
    } catch (err) { handleApiError(err); }
}

async function updateProfile(payload) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/pilota/${currentUser.psn_id}`, {
            method: 'PUT', headers: {'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
            body: JSON.stringify(payload)
        });
        if (!res.ok) return handleApiError(res);
        showNotification('Profilo aggiornato', 'success');
    } catch (err) { handleApiError(err); }
}

/* COMPLAINTS */
async function loadMyComplaints() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/reclami/miei`, {
            headers: {'Authorization': `Bearer ${getToken()}`}
        });
        if (!res.ok) return handleApiError(res);
        complaints = await res.json();
    } catch (err) { handleApiError(err); }
}

function renderComplaints() {
    const section = document.getElementById('complaintsSection') || document.getElementById('reclamiSection');
    if (!section) return;
    section.innerHTML = `
        <h2>I miei reclami</h2>
        <div>${(complaints || []).map(c=>`<div class="reclamo-card"><h4>${c.title}</h4><p>${c.status}</p></div>`).join('')}</div>
    `;
}

async function submitComplaint(data) {
    return submitComplaint; // existing submitComplaint function used above
}

async function showComplaintDetails(id) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/reclami/${id}`, { headers: {'Authorization': `Bearer ${getToken()}`} });
        if (!res.ok) return handleApiError(res);
        const c = await res.json();
        const modal = createModal();
        modal.querySelector('.modal-body').innerHTML = `<h3>${c.title}</h3><p>${c.description}</p><p>Status: ${c.status}</p>`;
        modal.style.display = 'block';
    } catch (err) { handleApiError(err); }
}

async function updateComplaintStatus(id, status) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/reclami/${id}/status`, {
            method: 'PUT', headers: {'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`},
            body: JSON.stringify({status})
        });
        if (!res.ok) return handleApiError(res);
        await loadMyComplaints();
        renderComplaints();
    } catch (err) { handleApiError(err); }
}

/* ADMIN */
async function renderAdmin() {
    if (!currentUser?.isAdmin) return showNotification('Accesso negato', 'error');
    const el = document.getElementById('adminSection');
    el.innerHTML = `<h2>Admin Panel</h2><p>Carica qui i risultati o gestisci risorse</p>`;
    loadAdminData();
}

async function loadAdminData() {
    try {
        const [champsRes, racesRes, usersRes] = await Promise.all([
            fetch(`${DB_CONFIG.apiUrl}/campionati`),
            fetch(`${DB_CONFIG.apiUrl}/gare`),
            fetch(`${DB_CONFIG.apiUrl}/piloti`)
        ]);
        // minimal handling
    } catch (err) { handleApiError(err); }
}

async function manageChampionships(action, payload) { /* CRUD via API */ }
async function manageRaces(action, payload) { /* CRUD via API */ }
async function manageUsers(action, payload) { /* CRUD via API */ }
async function reviewComplaints() { /* fetch pending */ }
async function uploadResults(file, meta) {
    // formdata to upload endpoint
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch(`${DB_CONFIG.apiUrl}/gare/${meta.garaId}/risultati`, {
        method: 'POST', headers: {'Authorization':`Bearer ${getToken()}`}, body: fd
    });
    if (!res.ok) return handleApiError(res);
    showNotification('Risultati caricati', 'success');
}
async function updateSettings(garaId, settings) { /* PUT to endpoint */ }

/* VICTORY BOARD */
async function renderVictoryBoard() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/bacheca/vittorie`);
        if (!res.ok) return handleApiError(res);
        const items = await res.json();
        const el = document.getElementById('victoryBoard') || document.createElement('div');
        el.id = 'victoryBoard';
        el.innerHTML = items.map(i => `<div><img src="${i.photo}" alt=""><p>${i.pilot} - ${formatDate(i.date)}</p></div>`).join('');
        document.getElementById('homeSection').appendChild(el);
    } catch (err) { handleApiError(err); }
}
async function uploadVictoryPhoto(file, meta) {
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch(`${DB_CONFIG.apiUrl}/bacheca/vittorie/foto`, { method: 'POST', headers: {'Authorization':`Bearer ${getToken()}`}, body: fd });
    if (!res.ok) return handleApiError(res);
    showNotification('Foto caricata', 'success');
}

/* CREDITS API */
async function loadCreditsData() {
    try {
        const token = getToken();
        if (!token) {
            showNotification('Devi effettuare il login', 'error');
            return;
        }

        // Carica stats crediti
        const [creditsRes, statsRes, historyRes] = await Promise.all([
            fetch(`${DB_CONFIG.apiUrl}/crediti`, {
                headers: {'Authorization': `Bearer ${token}`}
            }),
            fetch(`${DB_CONFIG.apiUrl}/crediti/stats`, {
                headers: {'Authorization': `Bearer ${token}`}
            }),
            fetch(`${DB_CONFIG.apiUrl}/crediti/storico`, {
                headers: {'Authorization': `Bearer ${token}`}
            })
        ]);

        if (!creditsRes.ok || !statsRes.ok || !historyRes.ok) {
            throw new Error('Errore nel caricamento dei crediti');
        }

        const credits = await creditsRes.json();
        const stats = await statsRes.json();
        const history = await historyRes.json();

        // Aggiorna UI
        document.getElementById('creditiDisponibili').textContent = credits.crediti?.crediti_disponibili || 0;
        document.getElementById('creditiUtilizzati').textContent = credits.crediti?.crediti_totali_utilizzati || 0;
        document.getElementById('chiamateOggi').textContent = stats.stats?.chiamate_oggi || 0;
        document.getElementById('chiamateSettimana').textContent = stats.stats?.chiamate_settimana || 0;

        // Renderizza storico
        renderCreditHistory(history.storico || []);

        // Mostra bottone ricarica per manager
        if (currentUser?.ruolo === 'manager') {
            document.getElementById('btnRicarica').style.display = 'block';
        }

    } catch (err) {
        console.error('Error loading credits:', err);
        showNotification('Errore nel caricamento dei crediti', 'error');
    }
}

function renderCreditHistory(history) {
    const container = document.getElementById('creditHistoryTable');

    if (!history || history.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#888;">Nessuno storico disponibile</p>';
        return;
    }

    const tableHTML = `
        <table class="history-table">
            <thead>
                <tr>
                    <th>Data/Ora</th>
                    <th>Endpoint</th>
                    <th>Metodo</th>
                    <th>Crediti</th>
                    <th>Status</th>
                    <th>Tempo (ms)</th>
                </tr>
            </thead>
            <tbody>
                ${history.map(h => `
                    <tr>
                        <td>${formatDateTime(h.created_at)}</td>
                        <td><code>${h.endpoint}</code></td>
                        <td><span class="badge">${h.metodo}</span></td>
                        <td>${h.crediti_consumati}</td>
                        <td><span class="status-${h.status_code}">${h.status_code}</span></td>
                        <td>${h.response_time_ms || '--'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    container.innerHTML = tableHTML;
}

function showRicaricaModal() {
    // Modal semplice per ricarica crediti (solo manager)
    const pilotaId = prompt('ID Pilota da ricaricare:');
    if (!pilotaId) return;

    const crediti = parseInt(prompt('Quantit√† crediti da aggiungere:'));
    if (!crediti || crediti <= 0) {
        showNotification('Quantit√† non valida', 'error');
        return;
    }

    const motivo = prompt('Motivo ricarica (opzionale):') || 'Ricarica manuale';

    ricaricaCrediti(pilotaId, crediti, motivo);
}

async function ricaricaCrediti(pilotaId, crediti, motivo) {
    try {
        const token = getToken();
        const res = await fetch(`${DB_CONFIG.apiUrl}/crediti/ricarica`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                pilota_id: parseInt(pilotaId),
                crediti: crediti,
                motivo: motivo
            })
        });

        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'Errore nella ricarica');
        }

        showNotification(`Ricaricati ${crediti} crediti con successo`, 'success');
        loadCreditsData(); // Ricarica dati

    } catch (err) {
        console.error('Error recharging credits:', err);
        showNotification(err.message, 'error');
    }
}

function formatDateTime(isoString) {
    if (!isoString) return '--';
    const date = new Date(isoString);
    return date.toLocaleString('it-IT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

/* NOTICE BOARD */
async function renderNoticeBoard() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/bacheca/avvisi`);
        if (!res.ok) return handleApiError(res);
        const notices = await res.json();
        const el = document.getElementById('noticeBoard') || document.createElement('div');
        el.id = 'noticeBoard';
        el.innerHTML = notices.map(n => `<div style="border-left:4px solid ${n.type==='alert'?'#f44336':'#ffc107'}"><h4>${n.title}</h4><p>${n.text}</p></div>`).join('');
        document.getElementById('homeSection').appendChild(el);
    } catch (err) { handleApiError(err); }
}
async function postNotice(payload) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/bacheca/avvisi`, { method: 'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`}, body: JSON.stringify(payload) });
        if (!res.ok) return handleApiError(res);
        renderNoticeBoard();
    } catch (err) { handleApiError(err); }
}
async function deleteNotice(id) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/bacheca/avvisi/${id}`, { method: 'DELETE', headers: {'Authorization':`Bearer ${getToken()}`}});
        if (!res.ok) return handleApiError(res);
        renderNoticeBoard();
    } catch (err) { handleApiError(err); }
}

/* TRAININGS */
async function renderTrainings() {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/allenamenti`);
        if (!res.ok) return handleApiError(res);
        const data = await res.json();
        const el = document.getElementById('trainingsSection') || document.createElement('div');
        el.id = 'trainingsSection';
        el.innerHTML = data.map(t=>`<div><h4>${t.title}</h4><p>${formatDate(t.date)}</p><button onclick="registerTraining(${t.id})">Iscriviti</button></div>`).join('');
        document.getElementById('homeSection').appendChild(el);
    } catch (err) { handleApiError(err); }
}
async function registerTraining(id) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/allenamenti/${id}/iscrizione`, { method:'POST', headers: {'Authorization':`Bearer ${getToken()}`}});
        if (!res.ok) return handleApiError(res);
        showNotification('Iscrizione allenamento confermata','success');
    } catch (err) { handleApiError(err); }
}
async function createTraining(payload) {
    try {
        const res = await fetch(`${DB_CONFIG.apiUrl}/allenamenti`, { method:'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${getToken()}`}, body: JSON.stringify(payload)});
        if (!res.ok) return handleApiError(res);
        renderTrainings();
    } catch (err) { handleApiError(err); }
}

/* UTILITIES */
function formatDate(dateString) {
    if (!dateString) return '';
    const d = new Date(dateString);
    return d.toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' }) + ' ' + d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
}

function validateForm(formEl) {
    // basic validation
    const inputs = [...formEl.querySelectorAll('[required]')];
    return inputs.every(i => i.value && i.value.trim() !== '');
}

async function handleApiError(errorOrResponse) {
    if (errorOrResponse?.json) {
        const err = await errorOrResponse.json().catch(()=>null);
        const msg = err?.message || errorOrResponse.statusText || 'Errore API';
        showNotification(msg, 'error');
    } else {
        showNotification(errorOrResponse.message || 'Errore', 'error');
    }
    console.error(errorOrResponse);
}

function updateLocalStorage(key, value) {
    if (value === null || value === undefined) localStorage.removeItem(key);
    else localStorage.setItem(key, JSON.stringify(value));
}

function getFromLocalStorage(key) {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return raw; }
}

/* HELPERS */
function createModal() {
    let modal = document.getElementById('modal');
    if (modal) return modal;
    modal = document.createElement('div');
    modal.id = 'modal';
    modal.style = 'position:fixed;left:0;top:0;width:100%;height:100%;display:block;background:rgba(0,0,0,0.6);';
    modal.innerHTML = `<div class="modal-content" style="background:#111;margin:50px auto;padding:20px;border-radius:8px;max-width:800px;color:#fff;"><div class="modal-body"></div><button onclick="closeModal()" style="margin-top:10px;">Chiudi</button></div>`;
    document.body.appendChild(modal);
    return modal;
}

function initAfterLogin() {
    initNavigation();
    initDashboard();
    renderProfile();
}

/* --- END NEW/REPLACED JS --- */
</script>

<nav class="nav">
    <button class="nav-btn active" data-section="home">üè† Home</button>
    <button class="nav-btn" data-section="standings">üèÜ Classifica</button>
    <button class="nav-btn" data-section="calendar">üìÖ Calendario</button>
    <button class="nav-btn" data-section="pilots">üë• Piloti</button>
    <button class="nav-btn" data-section="profile">üë§ Profilo</button>
    <button class="nav-btn" data-section="complaints">üìã Reclami</button>
    <button class="nav-btn" data-section="admin" id="adminButton">‚öôÔ∏è Admin</button>
</nav>

<section id="homeSection" class="section active">
    <h2>Benvenuto nella Dashboard</h2>
    <div class="quick-actions">
        <button onclick="showSection('calendar')" class="action-btn">
            üèÅ Prossima Gara
        </button>
        <button onclick="showSection('standings')" class="action-btn">
            üìä Mia Posizione
        </button>
        <button onclick="showSection('reclami')" class="action-btn">
            üìã Nuovo Reclamo
        </button>
    </div>
</section>

<section id="standingsSection" class="section">
    <h2>Classifiche</h2>
    <div class="filters">
        <select id="championshipSelect" onchange="filterStandings()">
            <option value="all">Tutti i Campionati</option>
            <option value="speed_vs_grip">Speed vs Grip</option>
            <option value="all_traction">All Traction</option>
        </select>
        <select id="categorySelect" onchange="filterStandings()">
            <option value="all">Tutte le Categorie</option>
            <option value="elite">Elite</option>
            <option value="star">Star</option>
        </select>
    </div>
    <table id="standingsTable">
        <!-- Contenuto della tabella generato da JavaScript -->
    </table>
</section>

<section id="calendarSection" class="section">
    <h2>Calendario Gare</h2>
    <!-- Contenuto del calendario generato da JavaScript -->
</section>

<section id="pilotsSection" class="section">
    <h2>Elenco Piloti</h2>
    <!-- Contenuto della lista piloti generato da JavaScript -->
</section>

<section id="profileSection" class="section">
    <h2>Profilo Utente</h2>
    <!-- Contenuto del profilo utente generato da JavaScript -->
</section>

<section id="creditsSection" class="section">
    <h2>ü™ô Crediti API</h2>
    <div class="credits-dashboard">
        <div class="credits-overview">
            <div class="credit-card">
                <div class="credit-label">Crediti Disponibili</div>
                <div class="credit-value" id="creditiDisponibili">--</div>
            </div>
            <div class="credit-card">
                <div class="credit-label">Crediti Utilizzati</div>
                <div class="credit-value" id="creditiUtilizzati">--</div>
            </div>
            <div class="credit-card">
                <div class="credit-label">Chiamate Oggi</div>
                <div class="credit-value" id="chiamateOggi">--</div>
            </div>
            <div class="credit-card">
                <div class="credit-label">Chiamate Settimana</div>
                <div class="credit-value" id="chiamateSettimana">--</div>
            </div>
        </div>

        <div class="credits-actions">
            <button onclick="loadCreditsData()" class="btn-refresh">üîÑ Aggiorna</button>
            <button onclick="showRicaricaModal()" class="btn-recharge" id="btnRicarica" style="display:none;">üí∞ Ricarica Crediti</button>
        </div>

        <div class="credits-history">
            <h3>Storico Utilizzo</h3>
            <div id="creditHistoryTable">
                <!-- Tabella storico generata da JavaScript -->
            </div>
        </div>
    </div>
</section>

<section id="complaintsSection" class="section">
    <h2>Gestione Reclami</h2>
    <!-- Contenuto della gestione reclami generato da JavaScript -->
</section>

<section id="adminSection" class="section">
    <h2>Pannello Admin</h2>
    <!-- Contenuto del pannello admin generato da JavaScript -->
</section>

<div class="upload-section">
  <form id="uploadForm" class="upload-form">
    <input type="file" id="fileInput" required>
    <button type="submit" class="btn-submit">üì§ Upload File</button>
  </form>
  <div id="uploadStatus"></div>
</div>