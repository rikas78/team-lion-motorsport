<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶Å Team Lion Motorsport</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #fff; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #e10600 0%, #8b0000 100%); padding: 20px 0; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h1 { text-align: center; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        nav { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; }
        .nav-btn { flex: 1; min-width: 120px; padding: 12px 20px; background: #2a2a2a; border: 2px solid #333; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s; font-size: 0.95rem; font-weight: 600; }
        .nav-btn:hover { background: #e10600; border-color: #e10600; transform: translateY(-2px); }
        .nav-btn.active { background: #e10600; border-color: #e10600; }
        .section { display: none; padding: 30px; background: #121212; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .section.active { display: block; }
        h2 { color: #e10600; margin-bottom: 20px; font-size: 2rem; border-bottom: 3px solid #e10600; padding-bottom: 10px; }
        h3 { color: #e10600; margin-bottom: 15px; font-size: 1.5rem; }
        .btn { padding: 12px 24px; background: #e10600; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; }
        .btn:hover { background: #c10500; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(225, 6, 0, 0.3); }
        .btn-secondary { background: #333; }
        .btn-secondary:hover { background: #444; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .card { padding: 20px; background: #1a1a1a; border: 2px solid #333; border-radius: 12px; transition: all 0.3s; }
        .card:hover { border-color: #e10600; transform: translateY(-5px); }
        .card.fire { background: linear-gradient(135deg, #8b0000 0%, #e10600 100%); border: none; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: #333; color: white; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.success { background: #4caf50; }
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }
        .notification.info { background: #2196f3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #1a1a1a; color: #e10600; font-weight: 700; }
        tr:hover { background: #1a1a1a; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: 600; }
        .badge-ufficiali { background: #4caf50; color: #fff; }
        .badge-academy { background: #2196f3; color: #fff; }
        .badge-junior { background: #ff9800; color: #fff; }
        .badge-urgente { background: #f44336; color: #fff; }
        .badge-evento { background: #9c27b0; color: #fff; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #e10600; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #333; border-radius: 6px; color: white; font-size: 1rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #e10600; }
        .auth-container { max-width: 500px; margin: 50px auto; }
        .auth-tabs { display: flex; gap: 0; margin-bottom: 30px; }
        .auth-tab { flex: 1; padding: 15px; background: #1a1a1a; border: none; color: white; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; }
        .auth-tab.active { background: #e10600; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .top5 { font-size: 0.9rem; }
        .top5 tr { cursor: pointer; }
        .comunicazione { padding: 15px; margin: 10px 0; background: #1a1a1a; border-left: 4px solid #e10600; border-radius: 6px; }
        .comunicazione.urgente { border-left-color: #f44336; }
        .lions-fire-badge { background: linear-gradient(135deg, #ff6b00, #e10600); padding: 8px 16px; border-radius: 20px; display: inline-block; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ü¶Å Team Lion Motorsport</h1>
        </div>
    </header>

    <div class="container">
        <nav>
            <button class="nav-btn active" data-section="home">üè† Home</button>
            <button class="nav-btn" data-section="standings">üèÜ Classifiche</button>
            <button class="nav-btn" data-section="calendar">üìÖ Calendario</button>
            <button class="nav-btn" data-section="upload">üì§ Upload CSV</button>
            <button class="nav-btn" data-section="profile" id="profileBtn" style="display:none;">üë§ Profilo</button>
            <button class="nav-btn" id="loginBtn" data-section="auth">üîê Login</button>
            <button class="nav-btn" id="logoutBtn" style="display:none;" onclick="logout()">üö™ Logout</button>
        </nav>

        <!-- HOME -->
        <section id="home" class="section active">
            <h2>Dashboard</h2>

            <!-- Comunicazioni Importanti -->
            <div id="comunicazioniBox"></div>

            <!-- Lions on Fire -->
            <div id="lionsOnFireBox"></div>

            <!-- Allenamenti Programmati -->
            <div id="allenamentiBox"></div>

            <!-- TOP 5 Classifiche -->
            <div id="top5Box"></div>
        </section>

        <!-- AUTH -->
        <section id="auth" class="section">
            <div class="auth-container">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">Registrati</button>
                </div>

                <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                    <h2>Login</h2>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" name="password" required>
                    </div>
                    <button type="submit" class="btn">Accedi</button>
                </form>

                <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                    <h2>Registrazione</h2>
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" name="nome" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label>PSN ID</label>
                        <input type="text" name="psn_id" required>
                    </div>
                    <button type="submit" class="btn">Registrati</button>
                </form>
            </div>
        </section>

        <!-- STANDINGS -->
        <section id="standings" class="section">
            <h2>Classifiche</h2>
            <div class="form-group">
                <select id="championshipFilter" onchange="loadStandings()">
                    <option value="1">All Traction 4.0</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Pilota</th>
                        <th>PSN ID</th>
                        <th>Categoria</th>
                        <th>Punti</th>
                        <th>Vittorie</th>
                        <th>Podi</th>
                        <th>Gare</th>
                    </tr>
                </thead>
                <tbody id="standingsTable"></tbody>
            </table>
        </section>

        <!-- CALENDAR -->
        <section id="calendar" class="section">
            <h2>Calendario Gare</h2>
            <div id="calendarList"></div>
        </section>

        <!-- UPLOAD CSV -->
        <section id="upload" class="section">
            <h2>Upload Risultati Gara</h2>
            <p style="color: #888; margin-bottom: 20px;">Carica il file CSV con i risultati ufficiali</p>
            <div class="form-group">
                <label>Seleziona Gara</label>
                <select id="garaSelect"></select>
            </div>
            <div style="padding: 40px; background: #1a1a1a; border: 3px dashed #333; border-radius: 12px; text-align: center; margin: 20px 0;">
                <h3>üìÑ Formato CSV</h3>
                <p>posizione,pilota_id,psn_id,tempo_totale,giro_veloce,auto_utilizzata</p>
                <input type="file" id="csvFile" accept=".csv" style="margin-top: 20px;">
            </div>
            <button class="btn" onclick="uploadCSV()">üì§ Carica Risultati</button>
            <div id="uploadStatus" style="margin-top: 20px;"></div>
        </section>

        <!-- PROFILE -->
        <section id="profile" class="section">
            <h2>Il Mio Profilo</h2>
            <div id="profileData"></div>
        </section>

        <!-- LIONS ON FIRE DETAIL -->
        <section id="lionsDetail" class="section">
            <h2>üî• Lions on Fire - Live Oggi</h2>
            <div id="lionsDetailContent"></div>
        </section>

        <!-- STANDINGS DETAIL -->
        <section id="standingsDetail" class="section">
            <button class="btn-secondary" onclick="showSection('standings')" style="margin-bottom: 20px;">‚Üê Indietro</button>
            <h2>Classifica Dettagliata</h2>
            <div id="standingsDetailContent"></div>
        </section>
    </div>

    <script>
        const API_URL = '/.netlify/functions/api';
        let currentUser = null;
        let campionatiData = [];

        // ========== AUTH ==========
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(Object.fromEntries(formData))
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                currentUser = data.user;
                localStorage.setItem('token', data.token);
                showNotification('‚úÖ Login effettuato!', 'success');
                updateUIAfterLogin();
                showSection('home');
                loadHomeData();
            } catch (err) {
                showNotification('‚ùå ' + err.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(Object.fromEntries(formData))
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error);
                currentUser = result.user;
                localStorage.setItem('token', result.token);
                showNotification('‚úÖ Registrazione completata!', 'success');
                updateUIAfterLogin();
                showSection('home');
                loadHomeData();
            } catch (err) {
                showNotification('‚ùå ' + err.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('token');
            document.getElementById('loginBtn').style.display = '';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('profileBtn').style.display = 'none';
            showNotification('Logout effettuato', 'info');
            showSection('home');
        }

        function updateUIAfterLogin() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = '';
            document.getElementById('profileBtn').style.display = '';
        }

        // ========== NAVIGATION ==========
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`[data-section="${sectionId}"]`)?.classList.add('active');

            if (sectionId === 'home') loadHomeData();
            if (sectionId === 'standings') loadStandings();
            if (sectionId === 'calendar') loadCalendar();
            if (sectionId === 'upload') loadGareForUpload();
            if (sectionId === 'profile') loadProfile();
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const section = btn.dataset.section;
                if (section) showSection(section);
            });
        });

        // ========== HOME DATA ==========
        async function loadHomeData() {
            await Promise.all([
                loadComunicazioni(),
                loadLionsOnFire(),
                loadAllenamenti(),
                loadTop5Classifiche()
            ]);
        }

        async function loadComunicazioni() {
            try {
                const res = await fetch(`${API_URL}/comunicazioni`);
                const data = await res.json();
                const box = document.getElementById('comunicazioniBox');
                if (data.comunicazioni && data.comunicazioni.length > 0) {
                    box.innerHTML = `
                        <h3>üì¢ Comunicazioni Importanti</h3>
                        ${data.comunicazioni.map(c => `
                            <div class="comunicazione ${c.tipo.toLowerCase()}">
                                <strong>${c.titolo}</strong>
                                ${c.tipo !== 'Info' ? `<span class="badge badge-${c.tipo.toLowerCase()}">${c.tipo}</span>` : ''}
                                <p>${c.messaggio}</p>
                                <small>${new Date(c.created_at).toLocaleDateString('it-IT')}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    box.innerHTML = '';
                }
            } catch (err) {
                console.error('Errore caricamento comunicazioni:', err);
            }
        }

        async function loadLionsOnFire() {
            try {
                const res = await fetch(`${API_URL}/lions-on-fire`);
                const data = await res.json();
                const box = document.getElementById('lionsOnFireBox');

                if (data.lions_on_fire && data.lions_on_fire.length > 0) {
                    box.innerHTML = `
                        <div class="card fire" onclick="showLionsDetail()" style="cursor: pointer;">
                            <h3>üî• <span class="lions-fire-badge">LIONS ON FIRE</span></h3>
                            <p style="font-size: 1.2rem; margin: 15px 0;">
                                <strong>${data.lions_on_fire[0].gara_nome}</strong>
                            </p>
                            <p>üìç ${data.lions_on_fire[0].circuito}</p>
                            <p>üèÅ ${data.lions_on_fire[0].totale_iscritti || 0} piloti in gara</p>
                            <p style="margin-top: 15px; font-size: 1.1rem;">
                                üëâ <strong>Clicca per vedere i piloti e lo streaming</strong>
                            </p>
                        </div>
                    `;
                } else {
                    box.innerHTML = '';
                }
            } catch (err) {
                console.error('Errore caricamento Lions on Fire:', err);
            }
        }

        async function showLionsDetail() {
            try {
                const res = await fetch(`${API_URL}/lions-on-fire`);
                const data = await res.json();

                if (data.lions_on_fire && data.lions_on_fire.length > 0) {
                    const lof = data.lions_on_fire[0];
                    document.getElementById('lionsDetailContent').innerHTML = `
                        <div class="card fire">
                            <h3>${lof.gara_nome}</h3>
                            <p><strong>Campionato:</strong> ${lof.campionato_nome}</p>
                            <p><strong>Circuito:</strong> ${lof.circuito}</p>
                            <p><strong>Data:</strong> ${new Date(lof.data_gara).toLocaleString('it-IT')}</p>
                            ${lof.canale_streaming ? `
                                <div style="margin: 20px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                    <h4>üì∫ Streaming Live</h4>
                                    <a href="${lof.canale_streaming}" target="_blank" class="btn" style="display: inline-block; text-decoration: none; margin-top: 10px;">
                                        üé• Guarda Live su Twitch
                                    </a>
                                </div>
                            ` : ''}
                            <h4 style="margin-top: 30px;">üë• Piloti in Gara (${lof.totale_iscritti || 0})</h4>
                            <div style="margin-top: 15px;">
                                ${lof.piloti_iscritti ? lof.piloti_iscritti.map(p => `
                                    <div style="padding: 10px; background: rgba(0,0,0,0.3); margin: 5px 0; border-radius: 6px;">
                                        ${p}
                                    </div>
                                `).join('') : '<p>Nessun pilota iscritto ancora</p>'}
                            </div>
                        </div>
                        <button class="btn-secondary" onclick="showSection('home')" style="margin-top: 20px;">‚Üê Torna alla Home</button>
                    `;
                    showSection('lionsDetail');
                }
            } catch (err) {
                showNotification('Errore caricamento dettagli', 'error');
            }
        }

        async function loadAllenamenti() {
            try {
                const res = await fetch(`${API_URL}/allenamenti`);
                const data = await res.json();
                const box = document.getElementById('allenamentiBox');

                if (data.allenamenti && data.allenamenti.length > 0) {
                    box.innerHTML = `
                        <h3>üèãÔ∏è Allenamenti Programmati</h3>
                        <div class="grid">
                            ${data.allenamenti.slice(0, 3).map(a => `
                                <div class="card">
                                    <h4>${a.titolo}</h4>
                                    <p>üìÖ ${new Date(a.data_allenamento).toLocaleString('it-IT')}</p>
                                    <p>üìç ${a.circuito || 'Da definire'}</p>
                                    <p>üë• ${a.totale_iscritti || 0}/${a.max_partecipanti || '‚àû'} iscritti</p>
                                    ${currentUser ? `
                                        <button class="btn" onclick="iscriviAllenamento(${a.id})" style="margin-top: 10px;">Iscriviti</button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    box.innerHTML = '';
                }
            } catch (err) {
                console.error('Errore caricamento allenamenti:', err);
            }
        }

        async function iscriviAllenamento(id) {
            if (!currentUser) {
                showNotification('Devi effettuare il login', 'warning');
                return;
            }
            try {
                const res = await fetch(`${API_URL}/allenamenti/${id}/iscrizione`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${localStorage.getItem('token')}`}
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                showNotification('‚úÖ Iscrizione effettuata!', 'success');
                loadAllenamenti();
            } catch (err) {
                showNotification('‚ùå ' + err.message, 'error');
            }
        }

        async function loadTop5Classifiche() {
            try {
                const res = await fetch(`${API_URL}/campionati`);
                const data = await res.json();
                campionatiData = data.campionati || [];

                const box = document.getElementById('top5Box');
                if (campionatiData.length > 0) {
                    const promises = campionatiData.slice(0, 2).map(async c => {
                        const classRes = await fetch(`${API_URL}/classifica?campionato_id=${c.id}`);
                        const classData = await classRes.json();
                        return { campionato: c, classifica: classData.classifica || [] };
                    });

                    const results = await Promise.all(promises);

                    box.innerHTML = `
                        <h3>üèÜ Classifiche Campionati</h3>
                        <div class="grid">
                            ${results.map(r => `
                                <div class="card" onclick="showStandingsDetail(${r.campionato.id})" style="cursor: pointer;">
                                    <h4>${r.campionato.nome}</h4>
                                    <table class="top5">
                                        <thead>
                                            <tr><th>Pos</th><th>Pilota</th><th>Punti</th></tr>
                                        </thead>
                                        <tbody>
                                            ${r.classifica.slice(0, 5).map((p, i) => `
                                                <tr>
                                                    <td>${i+1}</td>
                                                    <td>${p.nome}</td>
                                                    <td><strong>${p.punti}</strong></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                    <p style="margin-top: 10px; color: #e10600;">
                                        <strong>üëâ Clicca per vedere classifica completa</strong>
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Errore caricamento classifiche:', err);
            }
        }

        async function showStandingsDetail(campionatoId) {
            try {
                const res = await fetch(`${API_URL}/classifica/${campionatoId}/dettagli`);
                const data = await res.json();

                document.getElementById('standingsDetailContent').innerHTML = `
                    <div class="card">
                        <h3>${data.campionato.nome}</h3>
                        <p>${data.campionato.descrizione || ''}</p>
                        <div class="grid" style="margin: 20px 0;">
                            <div class="card">
                                <h4>Totale Piloti</h4>
                                <p style="font-size: 2rem; font-weight: bold; color: #e10600;">${data.statistiche.totale_piloti || 0}</p>
                            </div>
                            <div class="card">
                                <h4>Punti Leader</h4>
                                <p style="font-size: 2rem; font-weight: bold; color: #e10600;">${data.statistiche.punti_leader || 0}</p>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>#</th>
                                <th>Pilota</th>
                                <th>PSN ID</th>
                                <th>Categoria</th>
                                <th>Punti</th>
                                <th>Vittorie</th>
                                <th>Podi</th>
                                <th>Gare</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.classifica.map(p => `
                                <tr>
                                    <td><strong>${p.posizione_attuale || '-'}</strong></td>
                                    <td>${p.numero_gara || '-'}</td>
                                    <td><strong>${p.nome}</strong></td>
                                    <td>${p.psn_id}</td>
                                    <td><span class="badge badge-${p.categoria.toLowerCase()}">${p.categoria}</span></td>
                                    <td><strong>${p.punti_totali || 0}</strong></td>
                                    <td>üèÜ ${p.vittorie || 0}</td>
                                    <td>ü•á ${p.podi || 0}</td>
                                    <td>${p.gare_disputate || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                showSection('standingsDetail');
            } catch (err) {
                showNotification('Errore caricamento dettagli', 'error');
            }
        }

        // ========== STANDINGS ==========
        async function loadStandings() {
            const champId = document.getElementById('championshipFilter').value;
            try {
                const res = await fetch(`${API_URL}/classifica?campionato_id=${champId}`);
                const data = await res.json();
                const tbody = document.getElementById('standingsTable');
                tbody.innerHTML = data.classifica.map((p, i) => `
                    <tr>
                        <td><strong>${i + 1}</strong></td>
                        <td><strong>${p.nome}</strong></td>
                        <td>${p.psn_id || '-'}</td>
                        <td><span class="badge badge-${p.categoria.toLowerCase()}">${p.categoria}</span></td>
                        <td><strong>${p.punti}</strong></td>
                        <td>üèÜ ${p.vittorie}</td>
                        <td>ü•á ${p.podi}</td>
                        <td>${p.gare}</td>
                    </tr>
                `).join('');
            } catch (err) {
                showNotification('Errore caricamento classifiche', 'error');
            }
        }

        // ========== CALENDAR ==========
        async function loadCalendar() {
            try {
                const res = await fetch(`${API_URL}/gare?campionato_id=1`);
                const data = await res.json();
                document.getElementById('calendarList').innerHTML = data.gare.map(g => `
                    <div class="card">
                        <h3>${g.nome}</h3>
                        <p>üìç ${g.circuito}</p>
                        <p>üìÖ ${new Date(g.data_gara).toLocaleString('it-IT')}</p>
                        <p>‚è±Ô∏è ${g.durata_minuti} min | ${g.tipo_trazione}</p>
                        <p>Status: <strong>${g.status}</strong></p>
                    </div>
                `).join('');
            } catch (err) {
                showNotification('Errore caricamento calendario', 'error');
            }
        }

        // ========== UPLOAD CSV ==========
        async function loadGareForUpload() {
            try {
                const res = await fetch(`${API_URL}/gare`);
                const data = await res.json();
                const select = document.getElementById('garaSelect');
                select.innerHTML = data.gare.map(g =>
                    `<option value="${g.id}">${g.nome} - ${new Date(g.data_gara).toLocaleDateString('it-IT')}</option>`
                ).join('');
            } catch (err) {
                showNotification('Errore caricamento gare', 'error');
            }
        }

        async function uploadCSV() {
            const garaId = document.getElementById('garaSelect').value;
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) {
                showNotification('‚ùå Seleziona un file CSV', 'error');
                return;
            }
            if (!currentUser) {
                showNotification('‚ùå Effettua il login', 'error');
                return;
            }
            try {
                const csvData = await file.text();
                const res = await fetch(`${API_URL}/gare/${garaId}/upload-csv`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ csvData })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                showNotification('‚úÖ ' + data.message, 'success');
                document.getElementById('uploadStatus').innerHTML = `
                    <div class="card" style="border-color: #4caf50;">
                        <h4 style="color: #4caf50;">‚úÖ Upload Completato!</h4>
                        <p>${data.message}</p>
                    </div>
                `;
            } catch (err) {
                showNotification('‚ùå ' + err.message, 'error');
            }
        }

        // ========== PROFILE ==========
        async function loadProfile() {
            if (!currentUser) {
                document.getElementById('profileData').innerHTML = '<p>Effettua il login per vedere il tuo profilo</p>';
                return;
            }
            try {
                const token = localStorage.getItem('token');
                const [profileRes, statsRes, gareRes] = await Promise.all([
                    fetch(`${API_URL}/auth/me`, { headers: {'Authorization': `Bearer ${token}`}}),
                    fetch(`${API_URL}/piloti/${currentUser.id}/stats`),
                    fetch(`${API_URL}/piloti/${currentUser.id}/gare`)
                ]);
                const profile = await profileRes.json();
                const stats = await statsRes.json();
                const gare = await gareRes.json();

                document.getElementById('profileData').innerHTML = `
                    <div class="grid">
                        <div class="card">
                            <h3>üë§ ${profile.nome}</h3>
                            <p><strong>Email:</strong> ${profile.email}</p>
                            <p><strong>PSN ID:</strong> ${profile.psn_id}</p>
                            <p><strong>Numero Gara:</strong> ${profile.numero_gara || 'Non assegnato'}</p>
                            <p><strong>Categoria:</strong> <span class="badge badge-${profile.categoria.toLowerCase()}">${profile.categoria}</span></p>
                            <p><strong>Ruolo:</strong> ${profile.ruolo}</p>
                        </div>
                        <div class="card">
                            <h3>üìä Statistiche</h3>
                            <p><strong>Punti Totali:</strong> ${stats.pilota.punti_totali || 0}</p>
                            <p><strong>Vittorie:</strong> üèÜ ${stats.pilota.vittorie_totali || 0}</p>
                            <p><strong>Podi:</strong> ü•á ${stats.pilota.podi_totali || 0}</p>
                            <p><strong>Gare:</strong> ${stats.pilota.gare_totali || 0}</p>
                            <p><strong>Giri Veloci:</strong> ‚ö° ${stats.pilota.giri_veloci || 0}</p>
                            <p><strong>Media Posizione:</strong> ${stats.pilota.media_posizione_arrivo || '-'}</p>
                        </div>
                    </div>
                    <h3 style="margin-top: 30px;">üèÅ Ultime Gare</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Gara</th>
                                <th>Campionato</th>
                                <th>Posizione</th>
                                <th>Punti</th>
                                <th>Tempo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stats.ultime_gare && stats.ultime_gare.length > 0 ? stats.ultime_gare.map(g => `
                                <tr>
                                    <td>${new Date(g.data_gara).toLocaleDateString('it-IT')}</td>
                                    <td>${g.gara_nome}</td>
                                    <td>${g.campionato_nome}</td>
                                    <td><strong>${g.posizione_finale || '-'}</strong></td>
                                    <td>${g.punti_assegnati || 0}</td>
                                    <td>${g.tempo_totale || '-'}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="6">Nessuna gara disputata</td></tr>'}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                showNotification('Errore caricamento profilo', 'error');
            }
        }

        // ========== UTILS ==========
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        // ========== INIT ==========
        async function init() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const res = await fetch(`${API_URL}/auth/me`, {
                        headers: {'Authorization': `Bearer ${token}`}
                    });
                    if (res.ok) {
                        currentUser = await res.json();
                        updateUIAfterLogin();
                    }
                } catch (err) {
                    console.error('Token verification failed');
                }
            }
            loadHomeData();
        }

        init();
    </script>
</body>
</html>
